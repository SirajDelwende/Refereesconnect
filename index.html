<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GFA Referee Connect</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent" />
    <meta name="theme-color" content="#4169e1" />

    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow-x: hidden;
      }
      body {
        background: linear-gradient(135deg, #4169e1 0%, #00102d 100%);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 10px;
        font-family: "Segoe UI", sans-serif;
      }
      .container {
        width: 90%;
        max-width: 340px;
        background: rgba(108, 188, 227, 0.98);
        padding: 20px;
        border-radius: 24px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        margin-top: 5px;
        min-height: 500px;
      }
      .logo {
        display: block;
        margin: 0 auto 5px;
        max-width: 70px;
        height: auto;
      }
      header {
        text-align: center;
        margin-bottom: 15px;
      }
      header h1 {
        color: #002366;
        margin: 0;
        font-size: 1.3rem;
      }
      header p {
        color: #035416;
        font-size: 0.75rem;
        font-weight: bold;
      }

      .view-section {
        display: none;
      }
      .active-view {
        display: block;
        animation: fadeIn 0.4s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      input,
      select {
        width: 100%;
        padding: 10px;
        margin-bottom: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        font-size: 16px;
      }
      button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        background: #024705;
        color: white;
        font-weight: bold;
        cursor: pointer;
      }

      .ref-card {
        background: #ffffff;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
        border-left: 5px solid #010f37;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .contact-details {
        display: none;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
      }
      .contact-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }
      .action-link {
        flex: 1;
        text-align: center;
        padding: 8px;
        border-radius: 6px;
        text-decoration: none;
        color: white;
        font-size: 13px;
        font-weight: bold;
      }
      .wa-btn {
        background-color: #25d366;
      }
      .call-btn {
        background-color: #002366;
      }
      .del-btn {
        background-color: #c62828;
        font-size: 11px;
        padding: 6px;
        margin-top: 8px;
      }
      .forgot-link {
        display: block;
        text-align: right;
        margin-top: -10px;
        margin-bottom: 15px;
        font-size: 0.75rem;
        color: #002366;
        text-decoration: none;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <img src="Ghana-Football-Association.jpg" alt="Logo" class="logo" />
      <header>
        <h1>Referee Connect</h1>
        <p>Match Coordination Portal</p>
      </header>

      <div id="loginView" class="view-section active-view">
        <input type="email" id="loginEmail" placeholder="Email Address" />
        <input type="password" id="loginPass" placeholder="Password" />
        <a href="#" onclick="handleForgotPassword()" class="forgot-link"
          >Forgot Password?</a
        >
        <button onclick="handleLogin()">Login</button>
        <p style="text-align: center; margin-top: 15px; font-size: 0.85rem">
          New?
          <a
            href="#"
            onclick="showView('registerView')"
            style="color: #002366; font-weight: bold"
            >Sign up</a
          >
        </p>
      </div>

      <div id="registerView" class="view-section">
        <input type="text" id="regName" placeholder="Full Name" />
        <select id="regRegion">
          <option value="" disabled selected>Select Region</option>
          <option value="Greater Accra">Greater Accra</option>
          <option value="Ashanti">Ashanti</option>
          <option value="Eastern">Eastern</option>
          <option value="Western">Western</option>
          <option value="Central">Central</option>
          <option value="Volta">Volta</option>
          <option value="Northern">Northern</option>
          <option value="Upper East">Upper East</option>
          <option value="Upper West">Upper West</option>
          <option value="Bono Ahafo">Bono Ahafo</option>
        </select>
        <input type="tel" id="regPhone" placeholder="Phone Number" />
        <input type="email" id="regEmail" placeholder="Email" />
        <input type="password" id="regPass" placeholder="Password" />
        <button onclick="handleRegister()">Submit Registration</button>
        <p style="text-align: center; margin-top: 10px">
          <a href="#" onclick="showView('loginView')" style="font-size: 0.8rem"
            >Back</a
          >
        </p>
      </div>

      <div id="directoryView" class="view-section">
        <input
          type="text"
          id="searchInput"
          placeholder="Search name or region..."
          onkeyup="runFilter()" />
        <div id="refList"></div>
        <div style="display: flex; gap: 10px; margin-top: 15px">
          <button
            id="adminBtn"
            onclick="showView('adminView')"
            style="display: none; background: #002366">
            Admin Panel
          </button>
          <button onclick="logout()" style="background: #3e74c5">Logout</button>
        </div>
      </div>

      <div id="adminView" class="view-section">
        <h3 style="color: #d32f2f; font-size: 1rem; margin: 0 0 10px">
          Pending Approvals
        </h3>
        <div id="pendingList"></div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ccc" />

        <h3 style="color: #002366; font-size: 1rem; margin: 0 0 10px">
          Delete/Manage Members
        </h3>
        <input
          type="text"
          id="adminSearchInput"
          placeholder="Find member to delete..."
          onkeyup="runAdminFilter()" />
        <div id="adminFullList"></div>

        <button
          onclick="showView('directoryView')"
          style="background: #4169e1; margin-top: 15px">
          Back to Directory
        </button>
      </div>
    </div>

    <script type="module">
            // Register Service Worker for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(reg => console.log('Service Worker Registered!', reg))
            .catch(err => console.log('Service Worker Failed!', err));
        });
      }
      // --- YOUR FIREBASE CONFIG STARTS HERE ---
      const firebaseConfig = { ... };
      
          const firebaseConfig = {
              apiKey:"AIzaSyDE6XmDl8CF4oEYHZZ_01tn0ct_N84uTxo",
              authDomain:"referees-connect-app.firebaseapp.com",
              projectId:"referees-connect-app",
              storageBucket:"referees-connect-app.firebasestorage.app",
              messagingSenderId:"218749388164",
              appId:"1:218749388164:web:f6399de1346af790df49d1",
              measurementId:"G-BSW1J449HC"
          };

          import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
          import { getFirestore, doc, getDoc, setDoc, collection, query, where, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
          import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

          const app = initializeApp(firebaseConfig);
          const db = getFirestore(app);
          const auth = getAuth(app);

          let localRefList = [];
          let allApprovedList = [];
          let userData = null;

          window.showView = (viewId) => {
              document.querySelectorAll(".view-section").forEach((v) => v.classList.remove("active-view"));
              document.getElementById(viewId).classList.add("active-view");
          };

          // --- LOGIN & AUTH ---
          window.handleLogin = async () => {
              const email = document.getElementById("loginEmail").value;
              const pass = document.getElementById("loginPass").value;
              try {
                  const userCred = await signInWithEmailAndPassword(auth, email, pass);
                  const userDoc = await getDoc(doc(db, "applicants", userCred.user.uid));
                  if (userDoc.exists()) {
                      userData = userDoc.data();
                      if (userData.status === "approved") {
                          if (userData.isAdmin) document.getElementById("adminBtn").style.display = "block";
                          initDirectory();
                      } else { alert("Pending GFA approval."); await signOut(auth); }
                  }
              } catch (e) { alert("Error: " + e.message); }
          };

          window.handleForgotPassword = async () => {
              const email = document.getElementById("loginEmail").value;
              if (!email) return alert("Type your email first.");
              try { await sendPasswordResetEmail(auth, email); alert("Reset link sent to email!"); } catch (e) { alert(e.message); }
          };

          window.handleRegister = async () => {
              const email = document.getElementById("regEmail").value;
              const pass = document.getElementById("regPass").value;
              const data = {
                  fullName: document.getElementById("regName").value,
                  region: document.getElementById("regRegion").value,
                  phone: document.getElementById("regPhone").value,
                  email: email, status: "pending", isAdmin: false
              };
              try {
                  const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                  await setDoc(doc(db, "applicants", userCred.user.uid), data);
                  alert("Registration Successful. Pending Approval.");
                  showView("loginView");
              } catch (e) { alert(e.message); }
          };

          // --- DIRECTORY ---
          function initDirectory() {
              showView("directoryView");
              onSnapshot(query(collection(db, "applicants"), where("status", "==", "approved")), (snap) => {
                  localRefList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                  allApprovedList = localRefList;
                  renderAdminManageList(allApprovedList);
                  document.getElementById("refList").innerHTML = '<p style="text-align:center; color:#666;">Search name/region above.</p>';
              });
              if(userData.isAdmin) setupAdminListeners();
          }

          window.runFilter = () => {
              const q = document.getElementById("searchInput").value.toLowerCase().trim();
              const container = document.getElementById("refList");
              if (q.length === 0) { container.innerHTML = '<p style="text-align:center; color:#666;">Search names.</p>'; return; }
              const filtered = localRefList.filter(r => r.fullName.toLowerCase().includes(q) || r.region.toLowerCase().includes(q));
              container.innerHTML = filtered.map(ref => `
                  <div class="ref-card">
                      <div onclick="toggleDetails(this)" style="cursor:pointer;">
                          <strong>${ref.fullName}</strong><br><small>${ref.region}</small>
                      </div>
                      <div class="contact-details">
                          <p>Phone: ${ref.phone}<br>Email: ${ref.email}</p>
                          <div class="contact-actions">
                              <a href="tel:${ref.phone}" class="action-link call-btn">Call</a>
                              <a href="https://wa.me/${ref.phone.replace(/^0/, '233')}" class="action-link wa-btn" target="_blank">WhatsApp</a>
                          </div>
                      </div>
                  </div>`).join("");
          };

          window.toggleDetails = (el) => {
              const d = el.nextElementSibling;
              d.style.display = d.style.display === "block" ? "none" : "block";
          };

          // --- ADMIN SPECIFIC LOGIC ---
          function setupAdminListeners() {
              onSnapshot(query(collection(db, "applicants"), where("status", "==", "pending")), (snap) => {
                  document.getElementById("pendingList").innerHTML = snap.docs.map(d => `
                      <div class="ref-card" style="border-left-color:#d32f2f;">
                          <strong>${d.data().fullName}</strong> (${d.data().region})<br>
                          <button onclick="approveUser('${d.id}')" style="width:auto; padding:5px 10px; margin-top:5px; font-size:11px;">Approve</button>
                          <button onclick="deleteMember('${d.id}', '${d.data().fullName}')" class="del-btn" style="width:auto; padding:5px 10px;">Deny/Delete</button>
                      </div>`).join("");
              });
          }

          function renderAdminManageList(list) {
              const container = document.getElementById("adminFullList");
              container.innerHTML = list.map(ref => `
                  <div class="ref-card" style="padding:10px;">
                      <strong>${ref.fullName}</strong><br>
                      <small>${ref.email}</small><br>
                      <div style="display:flex; gap:5px; margin-top:8px;">
                          <button onclick="triggerReset('${ref.email}')" style="background:#002366; font-size:10px; padding:6px; width:auto;">Reset Password</button>
                          <button onclick="deleteMember('${ref.id}', '${ref.fullName}')" class="del-btn" style="margin:0; padding:6px; width:auto;">Delete</button>
                      </div>
                  </div>`).join("");
          }

          window.runAdminFilter = () => {
              const q = document.getElementById("adminSearchInput").value.toLowerCase();
              const filtered = allApprovedList.filter(r => r.fullName.toLowerCase().includes(q) || r.email.toLowerCase().includes(q));
              renderAdminManageList(filtered);
          };

          window.triggerReset = async (email) => {
              if(confirm(`Send a password reset email to ${email}?`)) {
                  try {
                      await sendPasswordResetEmail(auth, email);
                      alert("Reset email sent successfully!");
                  } catch (e) { alert("Error: " + e.message); }
              }
          };

          window.approveUser = async (uid) => {
              await updateDoc(doc(db, "applicants", uid), { status: "approved" });
              alert("Member Approved!");
          };

          window.deleteMember = async (uid, name) => {
              if (confirm(`Are you sure you want to delete ${name}?`)) {
                  await deleteDoc(doc(db, "applicants", uid));
                  alert("Member removed.");
              }
          };

          window.logout = () => location.reload();
    </script>
  </body>
</html>
