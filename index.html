<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="manifest" href="manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent" />
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GFA Referee Connect</title>
    <style>
      /* --- 1. GLOBAL MOBILE RESET --- */
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow-x: hidden;
      }

      body {
        background: linear-gradient(135deg, #4169e1 0%, #00102d 100%);
        display: flex;
        justify-content: center;
        align-items: flex-start; /* Pushes content to the top */
        padding-top: 10px; /* Minimal top gap */
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      /* Glassmorphism Container */
      .container {
        width: 90%;
        max-width: 340px;
        background: rgba(108, 188, 227, 0.98);
        padding: 20px;
        border-radius: 24px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        margin-top: 5px; /* Pushes app shell higher */
        min-height: 530px;
      }

      .logo {
        display: block;
        margin: 0 auto 5px;
        max-width: 70px; /* Smaller logo */
        height: auto;
      }

      header {
        text-align: center;
        margin-bottom: 15px;
      }

      header h1 {
        color: #002366;
        margin: 0;
        font-size: 1.3rem;
      }

      header p {
        color: #035416;
        font-size: 0.75rem;
        margin: 2px 0;
        font-weight: bold;
      }

      /* View Transitions */
      .view-section {
        display: none;
      }

      .active-view {
        display: block;
        animation: fadeIn 0.4s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Form Elements */
      input,
      select {
        width: 100%;
        padding: 10px;
        margin-bottom: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        font-size: 16px;
      }

      button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        background: #024705;
        color: white;
        font-weight: bold;
        cursor: pointer;
      }

      /* Member Cards */
      .ref-card {
        background: #ffffff;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
        border-left: 5px solid #010f37;
      }

      .contact-details {
        display: none;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
      }

      .contact-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }

      .action-link {
        flex: 1;
        text-align: center;
        padding: 8px;
        border-radius: 6px;
        text-decoration: none;
        color: white;
        font-size: 13px;
        font-weight: bold;
      }

      .wa-btn {
        background-color: #25d366;
      }
      .call-btn {
        background-color: #002366;
      }
      .del-btn {
        background-color: #c62828;
        font-size: 10px;
        padding: 4px;
        width: auto;
      }

      .forgot-link {
        display: block;
        text-align: right;
        margin-top: -10px;
        margin-bottom: 15px;
        font-size: 0.75rem;
        color: #002366;
        text-decoration: none;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <img src="Ghana-Football-Association.jpg" alt="Logo" class="logo" />

      <header>
        <h1>Referee Connect</h1>
        <p>Match Coordination Portal</p>
      </header>

      <div id="loginView" class="view-section active-view">
        <input type="email" id="loginEmail" placeholder="Email Address" />
        <input type="password" id="loginPass" placeholder="Password" />
        <a href="#" onclick="handleForgotPassword()" class="forgot-link"
          >Forgot Password?</a
        >

        <button onclick="handleLogin()">Login</button>

        <p style="text-align: center; margin-top: 15px; font-size: 0.85rem">
          New?
          <a
            href="#"
            onclick="showView('registerView')"
            style="color: #002366; font-weight: bold"
            >Sign up</a
          >
        </p>
      </div>

      <div id="registerView" class="view-section">
        <input type="text" id="regName" placeholder="Full Name" />
        <select id="regRole">
          <option value="" disabled selected>Role</option>
          <option value="Referee">Referee</option>
          <option value="Assistant Referee">Assistant Referee</option>
        </select>
        <select id="regRegion">
          <option value="" disabled selected>Region</option>
          <option value="Greater Accra">Greater Accra</option>
          <option value="Ashanti">Ashanti</option>
          <option value="Northern">Northern</option>
          <option value="Volta">Volta</option>
          <option value="Western">Western</option>
          <option value="Eastern">Eastern</option>
          <option value="Eastern">Upper East</option>
          <option value="Eastern">Upper West</option>
          <option value="Eastern">Central</option>
          <option value="Eastern">Bono Ahafo</option>
        </select>
        <select id="regLeague">
          <option value="" disabled selected>League</option>
          <option value="Premier">Premier</option>
          <option value="Division One">Division One</option>
          <option value="Women Premier">Women Premier</option>
        </select>
        <input type="tel" id="regPhone" placeholder="Phone Number" />
        <input type="email" id="regEmail" placeholder="Email" />
        <input type="password" id="regPass" placeholder="Password" />
        <button onclick="handleRegister()">Submit Registration</button>
        <p style="text-align: center; margin-top: 10px">
          <a href="#" onclick="showView('loginView')" style="font-size: 0.8rem"
            >Back to Login</a
          >
        </p>
      </div>

      <div id="directoryView" class="view-section">
        <input
          type="text"
          id="searchInput"
          placeholder="Search name..."
          onkeyup="runFilter()" />
        <div id="refList"></div>
        <div style="display: flex; gap: 10px; margin-top: 15px">
          <button
            id="adminBtn"
            onclick="showView('adminView')"
            style="display: none; background: #002366">
            Admin
          </button>
          <button onclick="logout()" style="background: #3e74c5">Logout</button>
        </div>
      </div>

      <div id="adminView" class="view-section">
        <h3 style="color: #d32f2f; font-size: 1rem">Pending</h3>
        <div id="pendingList"></div>
        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #ccc" />
        <button onclick="showView('directoryView')" style="background: #4169e1">
          Back
        </button>
      </div>
    </div>

    <script type="module">
      const firebaseConfig = {
        apiKey: "AIzaSyDE6XmDl8CF4oEYHZZ_01tn0ct_N84uTxo",
        authDomain: "referees-connect-app.firebaseapp.com",
        projectId: "referees-connect-app",
        storageBucket: "referees-connect-app.firebasestorage.app",
        messagingSenderId: "218749388164",
        appId: "1:218749388164:web:f6399de1346af790df49d1",
        measurementId: "G-BSW1J449HC",
      };

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        collection,
        query,
        where,
        onSnapshot,
        updateDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        sendPasswordResetEmail,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      let localRefList = [];
      let userData = null;

      window.showView = (viewId) => {
        document
          .querySelectorAll(".view-section")
          .forEach((v) => v.classList.remove("active-view"));
        document.getElementById(viewId).classList.add("active-view");
      };

      window.handleLogin = async () => {
        const email = document.getElementById("loginEmail").value;
        const pass = document.getElementById("loginPass").value;
        if (!email || !pass) return alert("Fill fields.");
        try {
          const userCred = await signInWithEmailAndPassword(auth, email, pass);
          const userDoc = await getDoc(
            doc(db, "applicants", userCred.user.uid)
          );
          if (userDoc.exists()) {
            userData = userDoc.data();
            if (userData.status === "approved") {
              if (userData.isAdmin)
                document.getElementById("adminBtn").style.display = "block";
              initDirectory();
            } else {
              alert("Pending GFA approval.");
              await signOut(auth);
            }
          }
        } catch (e) {
          alert("Login Error: " + e.message);
        }
      };

      window.handleForgotPassword = async () => {
        const email = document.getElementById("loginEmail").value;
        if (!email) return alert("Enter email address above first.");
        try {
          await sendPasswordResetEmail(auth, email);
          alert("Reset link sent to your email!");
        } catch (e) {
          alert("Error: " + e.message);
        }
      };

      window.handleRegister = async () => {
        const email = document.getElementById("regEmail").value;
        const pass = document.getElementById("regPass").value;
        const data = {
          fullName: document.getElementById("regName").value,
          role: document.getElementById("regRole").value,
          region: document.getElementById("regRegion").value,
          league: document.getElementById("regLeague").value,
          phone: document.getElementById("regPhone").value,
          email: email,
          status: "pending",
          isAdmin: false,
        };
        try {
          const userCred = await createUserWithEmailAndPassword(
            auth,
            email,
            pass
          );
          await setDoc(doc(db, "applicants", userCred.user.uid), data);
          alert("Submitted! Contact GFA for approval.");
          showView("loginView");
        } catch (e) {
          alert("Error: " + e.message);
        }
      };

      function initDirectory() {
        showView("directoryView");
        onSnapshot(
          query(
            collection(db, "applicants"),
            where("status", "==", "approved")
          ),
          (snap) => {
            localRefList = snap.docs.map((d) => d.data());
            document.getElementById("refList").innerHTML =
              '<p style="text-align:center; color:#666; font-size:0.8rem; margin-top:10px;">Search names above.</p>';
          }
        );
        if (userData.isAdmin) setupAdminQueue();
      }

      window.runFilter = () => {
        const q = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();
        const container = document.getElementById("refList");
        if (q.length === 0) {
          container.innerHTML =
            '<p style="text-align:center; color:#666;">Search names.</p>';
          return;
        }
        const filtered = localRefList.filter((r) =>
          r.fullName.toLowerCase().includes(q)
        );
        container.innerHTML = filtered
          .map((ref) => {
            let waPhone = ref.phone.replace(/\s+/g, "");
            if (waPhone.startsWith("0")) waPhone = "233" + waPhone.substring(1);
            return `
            <div class="ref-card">
              <div onclick="toggleDetails(this)" style="cursor:pointer;">
                <strong style="color:#002366;">${ref.fullName}</strong><br>
                <small style="color:#2e7d32;">${ref.region} â€¢ View</small>
              </div>
              <div class="contact-details">
                <p>Role: ${ref.role}<br>League: ${ref.league}<br>Phone: ${ref.phone}</p>
                <div class="contact-actions">
                  <a href="https://wa.me/${waPhone}" class="action-link wa-btn" target="_blank">WhatsApp</a>
                  <a href="tel:${ref.phone}" class="action-link call-btn">Call</a>
                </div>
              </div>
            </div>`;
          })
          .join("");
      };

      window.toggleDetails = (el) => {
        const d = el.nextElementSibling;
        d.style.display = d.style.display === "block" ? "none" : "block";
      };

      function setupAdminQueue() {
        onSnapshot(
          query(collection(db, "applicants"), where("status", "==", "pending")),
          (snap) => {
            document.getElementById("pendingList").innerHTML = snap.docs
              .map(
                (d) => `
            <div class="ref-card" style="border-left-color:#d32f2f;">
              <strong>${d.data().fullName}</strong><br>
              <button onclick="approveUser('${
                d.id
              }')" style="width:auto; padding:4px 8px; margin-top:5px; font-size:10px;">Approve</button>
            </div>`
              )
              .join("");
          }
        );
      }

      window.approveUser = async (uid) => {
        await updateDoc(doc(db, "applicants", uid), { status: "approved" });
        alert("Approved!");
      };

      window.logout = () => location.reload();
    </script>
  </body>
</html>
